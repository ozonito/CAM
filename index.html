<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz de Flashcards Legales</title>
    <style>
        :root {
            --bg-color: #121212;
            --primary-text-color: #e0e0e0;
            --secondary-text-color: #b3b3b3;
            --card-bg-color: #1e1e1e;
            --border-color: #333;
            --accent-color: #bb86fc;
            --accent-color-dark: #3700b3;
            --correct-color: #03dac6;
            --incorrect-color: #cf6679;
            --button-hover-bg: #333333;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
        }

        .container {
            width: 100%;
            max-width: 800px;
            padding: 20px;
            background-color: var(--card-bg-color);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        h1, h2 {
            color: var(--accent-color);
        }

        /* --- Pantalla de ConfiguraciÃ³n --- */
        #setup-screen .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        #setup-screen label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--secondary-text-color);
        }

        #setup-screen input, #setup-screen select {
            width: 100%;
            padding: 12px;
            background-color: var(--bg-color);
            color: var(--primary-text-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            box-sizing: border-box;
        }

        /* --- Pantalla del Quiz --- */
        #quiz-screen {
            display: none;
        }

        #progress-container {
            margin-bottom: 20px;
        }

        #progress-text {
            font-size: 0.9em;
            color: var(--secondary-text-color);
        }

        #progress-bar-full {
            width: 100%;
            height: 8px;
            background-color: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        #progress-bar {
            height: 100%;
            width: 0%;
            background-color: var(--accent-color);
            transition: width 0.3s ease-in-out;
        }

        #flashcard {
            background-color: #2c2c2c;
            padding: 25px;
            border-radius: 10px;
            border-left: 5px solid var(--accent-color);
            margin-bottom: 25px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #question-text {
            font-size: 1.3em;
            font-weight: 500;
        }

        #options-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .option-btn {
            padding: 15px;
            font-size: 1em;
            background-color: var(--bg-color);
            color: var(--primary-text-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            text-align: left;
            line-height: 1.5;
        }

        .option-btn:hover:not(:disabled) {
            background-color: var(--button-hover-bg);
            border-color: var(--accent-color);
        }

        .option-btn.correct {
            background-color: var(--correct-color);
            color: #000;
            border-color: var(--correct-color);
        }

        .option-btn.incorrect {
            background-color: var(--incorrect-color);
            color: #000;
            border-color: var(--incorrect-color);
        }

        .option-btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        #feedback-container {
            margin-top: 20px;
            font-size: 1.1em;
            font-weight: bold;
            min-height: 50px;
        }

        #feedback-text a {
            color: var(--correct-color);
            text-decoration: none;
        }
         #feedback-text a:hover {
            text-decoration: underline;
        }

        /* --- Pantalla de Resultados --- */
        #results-screen {
            display: none;
            text-align: left;
        }
        
        #results-screen h2, #results-screen h3 {
            text-align: center;
        }

        #review-list {
            list-style-type: none;
            padding: 0;
        }

        #review-list li {
            background-color: #2c2c2c;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--incorrect-color);
        }
        
        .review-question {
            font-weight: bold;
            color: var(--secondary-text-color);
        }

        .review-answer {
            color: var(--correct-color);
            margin-top: 8px;
        }
        
        #usage-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }

        #usage-table th, #usage-table td {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: left;
        }

        #usage-table th {
            background-color: #2c2c2c;
        }

        #results-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 25px;
        }


        /* --- Botones --- */
        .btn {
            background-color: var(--accent-color);
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        .btn:hover {
            background-color: var(--accent-color-dark);
            color: var(--primary-text-color);
        }
        
        .btn-secondary {
            background-color: var(--button-hover-bg);
            color: var(--primary-text-color);
        }

        .btn-secondary:hover {
            background-color: var(--border-color);
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- 1. PANTALLA DE CONFIGURACIÃ“N -->
        <div id="setup-screen">
            <h1>Flashcards Legales Interactivas</h1>
            <p style="color: var(--secondary-text-color);">PrepÃ¡rate para el Ã©xito. Elige tus ajustes y Â¡a por ello!</p>
            <div class="form-group">
                <label for="num-questions">Â¿CuÃ¡ntas preguntas quieres hoy?</label>
                <input type="number" id="num-questions" min="1" value="10">
            </div>
            <div class="form-group">
                <label for="topic-select">Elige el bloque temÃ¡tico:</label>
                <select id="topic-select">
                    <option value="TODO">TODO</option>
                    <option value="administrativo">Administrativo</option>
                    <option value="civil">Civil</option>
                    <option value="mercantil">Mercantil</option>
                </select>
            </div>
            <button id="start-quiz-btn" class="btn">Empezar el DesafÃ­o</button>
        </div>

        <!-- 2. PANTALLA DEL QUIZ -->
        <div id="quiz-screen">
            <div id="progress-container">
                <p id="progress-text">Pregunta 1 de 10</p>
                <div id="progress-bar-full">
                    <div id="progress-bar"></div>
                </div>
            </div>
            <div id="flashcard">
                <p id="question-text">AquÃ­ va la pregunta...</p>
            </div>
            <div id="options-container">
                <!-- Las opciones se generan con JS -->
            </div>
            <div id="feedback-container">
                <p id="feedback-text"></p>
            </div>
            <button id="next-question-btn" class="btn hidden">Siguiente Pregunta</button>
        </div>

        <!-- 3. PANTALLA DE RESULTADOS -->
        <div id="results-screen">
            <h2>Â¡Reto completado!</h2>
            <p id="score-text" style="font-size: 1.2em; text-align: center;"></p>
            <p id="motivational-closing" style="text-align: center; color: var(--secondary-text-color);"></p>
            
            <div id="review-container">
                <h3>Conceptos a repasar:</h3>
                <ul id="review-list"></ul>
            </div>
            
            <h3>EstadÃ­sticas de Uso de Preguntas</h3>
            <table id="usage-table">
                <thead>
                    <tr>
                        <th>ID Pregunta</th>
                        <th>Veces Formulada</th>
                    </tr>
                </thead>
                <tbody id="usage-table-body">
                </tbody>
            </table>

            <div id="results-buttons">
                <button id="restart-quiz-btn" class="btn">Empezar un Nuevo Quiz</button>
                <button id="download-csv-btn" class="btn btn-secondary">Descargar Informe de Uso (CSV)</button>
            </div>
        </div>
    </div>

    <script>
    // --- BASE DE DATOS DE PREGUNTAS (del CSV) ---
    const flashcardsData = [
        {"ID":1,"BLOQUE":"administrativo","PREGUNTA":"Â¿QuÃ© plazo general establece la Ley 39/2015 para que la AdministraciÃ³n resuelva y notifique un procedimiento si ninguna norma especÃ­fica indica otro?","RESPUESTA":"El plazo mÃ¡ximo es de tres meses.","ARTICULO":"Art. 21.3 Ley 39/2015"},
        {"ID":2,"BLOQUE":"administrativo","PREGUNTA":"Â¿Contra una resoluciÃ³n que pone fin a la vÃ­a administrativa, quÃ© recurso se puede interponer?","RESPUESTA":"Recurso potestativo de reposiciÃ³n o directamente recurso contencioso-administrativo.","ARTICULO":"Art. 123 Ley 39/2015"},
        {"ID":3,"BLOQUE":"administrativo","PREGUNTA":"SegÃºn la Ley 40/2015, Â¿quiÃ©nes componen el sector pÃºblico institucional?","RESPUESTA":"Organismos pÃºblicos, autoridades administrativas independientes, sociedades mercantiles estatales, consorcios, fundaciones del sector pÃºblico, y universidades pÃºblicas no transferidas.","ARTICULO":"Art. 84 Ley 40/2015"},
        {"ID":4,"BLOQUE":"administrativo","PREGUNTA":"Â¿CuÃ¡l es el plazo para interponer un recurso de alzada contra un acto administrativo que no es expreso (silencio administrativo)?","RESPUESTA":"Se puede interponer en cualquier momento a partir del dÃ­a siguiente a aquel en que se produzcan los efectos del silencio administrativo.","ARTICULO":"Art. 122.1 Ley 39/2015"},
        {"ID":5,"BLOQUE":"administrativo","PREGUNTA":"Â¿QuÃ© tipo de responsabilidad patrimonial de la AdministraciÃ³n PÃºblica se regula en la Ley 39/2015?","RESPUESTA":"Responsabilidad objetiva, donde el particular solo debe probar la lesiÃ³n, el daÃ±o y el nexo causal con el funcionamiento del servicio pÃºblico.","ARTICULO":"Art. 32 Ley 40/2015"},
        {"ID":6,"BLOQUE":"civil","PREGUNTA":"Â¿A partir de quÃ© edad se adquiere la plena capacidad de obrar, segÃºn el CÃ³digo Civil espaÃ±ol?","RESPUESTA":"A los 18 aÃ±os, con la mayorÃ­a de edad.","ARTICULO":"Art. 240 CÃ³digo Civil"},
        {"ID":7,"BLOQUE":"civil","PREGUNTA":"Â¿CuÃ¡l es el plazo de prescripciÃ³n general para las acciones personales que no tengan un plazo especial fijado en el CÃ³digo Civil?","RESPUESTA":"Cinco aÃ±os.","ARTICULO":"Art. 1964.2 CÃ³digo Civil"},
        {"ID":8,"BLOQUE":"civil","PREGUNTA":"Â¿QuÃ© es un testamento olÃ³grafo?","RESPUESTA":"Es el testamento escrito de puÃ±o y letra por el testador, mayor de edad, con expresiÃ³n del aÃ±o, mes y dÃ­a en que se otorgue.","ARTICULO":"Art. 688 CÃ³digo Civil"},
        {"ID":9,"BLOQUE":"civil","PREGUNTA":"En un contrato de compraventa, Â¿quiÃ©n paga los gastos de otorgamiento de escrituras por defecto?","RESPUESTA":"Los gastos de la escritura matriz serÃ¡n de cuenta del vendedor, y los de la primera copia y los demÃ¡s posteriores a la venta serÃ¡n de cuenta del comprador, salvo pacto en contrario.","ARTICULO":"Art. 1455 CÃ³digo Civil"},
        {"ID":10,"BLOQUE":"civil","PREGUNTA":"Â¿QuÃ© es la usucapiÃ³n o prescripciÃ³n adquisitiva?","RESPUESTA":"Es un modo de adquirir la propiedad y otros derechos reales por la posesiÃ³n de una cosa durante un tiempo determinado y con las condiciones que fija la ley.","ARTICULO":"Art. 1930 CÃ³digo Civil"},
        {"ID":11,"BLOQUE":"mercantil","PREGUNTA":"Â¿CuÃ¡l es el capital social mÃ­nimo para constituir una Sociedad de Responsabilidad Limitada (SRL) en EspaÃ±a?","RESPUESTA":"Un euro, desde la entrada en vigor de la Ley Crea y Crece.","ARTICULO":"Art. 4 Ley de Sociedades de Capital"},
        {"ID":12,"BLOQUE":"mercantil","PREGUNTA":"Â¿QuÃ© es un concurso de acreedores?","RESPUESTA":"Un procedimiento judicial que se inicia cuando una persona fÃ­sica o jurÃ­dica se encuentra en estado de insolvencia y no puede cumplir regularmente sus obligaciones de pago.","ARTICULO":"Texto Refundido de la Ley Concursal"},
        {"ID":13,"BLOQUE":"mercantil","PREGUNTA":"Â¿QuÃ© duraciÃ³n tiene el cargo de administrador en una Sociedad AnÃ³nima (SA), segÃºn la Ley de Sociedades de Capital?","RESPUESTA":"El que determinen los estatutos sociales, pero no podrÃ¡ exceder de seis aÃ±os y deberÃ¡ ser el mismo para todos ellos.","ARTICULO":"Art. 221 Ley de Sociedades de Capital"},
        {"ID":14,"BLOQUE":"mercantil","PREGUNTA":"Â¿QuÃ© es una letra de cambio?","RESPUESTA":"Un tÃ­tulo-valor que contiene una orden incondicionada, dada por una persona (librador) a otra (librado), de pagar una suma determinada a un tercero (tomador) o a su orden.","ARTICULO":"Ley 19/1985, Cambiaria y del Cheque"},
        {"ID":15,"BLOQUE":"mercantil","PREGUNTA":"En una Sociedad AnÃ³nima, Â¿quÃ© quorum de asistencia se requiere, en primera convocatoria, para que la junta general ordinaria o extraordinaria pueda adoptar acuerdos?","RESPUESTA":"Los accionistas presentes o representados deberÃ¡n poseer, al menos, el 25% del capital suscrito con derecho a voto.","ARTICULO":"Art. 193 Ley de Sociedades de Capital"}
    ];

    // --- ELEMENTOS DEL DOM ---
    const setupScreen = document.getElementById('setup-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const resultsScreen = document.getElementById('results-screen');

    const startQuizBtn = document.getElementById('start-quiz-btn');
    const numQuestionsInput = document.getElementById('num-questions');
    const topicSelect = document.getElementById('topic-select');

    const progressText = document.getElementById('progress-text');
    const progressBar = document.getElementById('progress-bar');
    const questionText = document.getElementById('question-text');
    const optionsContainer = document.getElementById('options-container');
    const feedbackText = document.getElementById('feedback-text');
    const nextQuestionBtn = document.getElementById('next-question-btn');

    const scoreText = document.getElementById('score-text');
    const motivationalClosing = document.getElementById('motivational-closing');
    const reviewContainer = document.getElementById('review-container');
    const reviewList = document.getElementById('review-list');
    const usageTableBody = document.getElementById('usage-table-body');
    const restartQuizBtn = document.getElementById('restart-quiz-btn');
    const downloadCsvBtn = document.getElementById('download-csv-btn');

    // --- ESTADO DEL JUEGO ---
    let currentQuizQuestions = [];
    let currentQuestionIndex = 0;
    let score = 0;
    let incorrectAnswers = [];

    // --- FRASES MOTIVACIONALES ---
    const positivePhrases = ["Â¡Excelente!", "Â¡Sigue asÃ­!", "Â¡Imparable!", "Â¡Dominando la materia!", "Â¡Lo sabÃ­as!"];
    const encouragingPhrases = ["Â¡Ãnimo!", "Â¡El error es parte del aprendizaje!", "Â¡La prÃ³xima serÃ¡!", "Â¡Sigue esforzÃ¡ndote!"];
    const closingPhrases = [
        "Cada pregunta respondida es un paso mÃ¡s hacia tu meta. Â¡Sigue adelante con determinaciÃ³n!",
        "El conocimiento es poder. Hoy has demostrado tu compromiso. Â¡No te detengas!",
        "El esfuerzo de hoy es la victoria de maÃ±ana. Â¡Gran trabajo!",
        "Has completado el desafÃ­o. Analiza tus resultados y vuelve mÃ¡s fuerte."
    ];

    // --- LÃ“GICA DE LOCALSTORAGE (SISTEMA DE NO REPETICIÃ“N) ---
    const storageKeys = {
        seen: 'flashcardQuizSeenQuestions',
        usage: 'flashcardQuizUsageCount'
    };

    const getFromStorage = (key) => {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : {};
    };

    const saveToStorage = (key, data) => {
        localStorage.setItem(key, JSON.stringify(data));
    };
    
    // --- LÃ“GICA DEL JUEGO ---

    startQuizBtn.addEventListener('click', startQuiz);
    nextQuestionBtn.addEventListener('click', showNextQuestion);
    restartQuizBtn.addEventListener('click', () => {
        resultsScreen.style.display = 'none';
        setupScreen.style.display = 'block';
    });
    downloadCsvBtn.addEventListener('click', downloadUsageReport);

    function startQuiz() {
        const numQuestions = parseInt(numQuestionsInput.value);
        const selectedTopic = topicSelect.value;

        let availableQuestions = flashcardsData;
        if (selectedTopic !== 'TODO') {
            availableQuestions = flashcardsData.filter(q => q.BLOQUE === selectedTopic);
        }

        let seenQuestions = getFromStorage(storageKeys.seen);
        let seenInTopic = seenQuestions[selectedTopic] || [];
        
        let unseenQuestions = availableQuestions.filter(q => !seenInTopic.includes(q.ID));

        if (unseenQuestions.length === 0 && availableQuestions.length > 0) {
            alert(`Â¡Enhorabuena! Has completado todas las preguntas del bloque '${selectedTopic}'. El ciclo se reiniciarÃ¡.`);
            seenInTopic = [];
            unseenQuestions = availableQuestions;
            // Actualizar el storage para reflejar el reinicio
            seenQuestions[selectedTopic] = [];
            saveToStorage(storageKeys.seen, seenQuestions);
        }
        
        currentQuizQuestions = shuffleArray(unseenQuestions).slice(0, numQuestions);

        if(currentQuizQuestions.length < numQuestions && currentQuizQuestions.length > 0){
            alert(`Solo quedan ${currentQuizQuestions.length} preguntas sin ver en este bloque. Se mostrarÃ¡n esas.`);
        }
        
        if (currentQuizQuestions.length === 0) {
            alert("No hay preguntas disponibles para los criterios seleccionados.");
            return;
        }

        currentQuestionIndex = 0;
        score = 0;
        incorrectAnswers = [];
        
        setupScreen.style.display = 'none';
        quizScreen.style.display = 'block';
        resultsScreen.style.display = 'none';
        nextQuestionBtn.classList.add('hidden');
        
        displayQuestion();
    }
    
    function displayQuestion() {
        if (currentQuestionIndex >= currentQuizQuestions.length) {
            showResults();
            return;
        }

        const question = currentQuizQuestions[currentQuestionIndex];
        
        const progress = ((currentQuestionIndex + 1) / currentQuizQuestions.length) * 100;
        progressText.textContent = `Pregunta ${currentQuestionIndex + 1} de ${currentQuizQuestions.length} | Progreso Total: ${Math.round(progress)}%`;
        progressBar.style.width = `${progress}%`;

        questionText.textContent = question.PREGUNTA;
        optionsContainer.innerHTML = '';
        feedbackText.innerHTML = '';

        const correctAnswer = `${question.RESPUESTA} (${question.ARTICULO})`;
        const incorrectOptions = generateIncorrectOptions(question);
        const options = shuffleArray([correctAnswer, ...incorrectOptions]);

        options.forEach(optionText => {
            const button = document.createElement('button');
            button.className = 'option-btn';
            button.innerHTML = optionText;
            button.addEventListener('click', () => selectAnswer(button, optionText, correctAnswer));
            optionsContainer.appendChild(button);
        });

        nextQuestionBtn.classList.add('hidden');
    }

    function selectAnswer(button, selectedAnswer, correctAnswer) {
        Array.from(optionsContainer.children).forEach(btn => {
            btn.disabled = true;
            if (btn.innerHTML === correctAnswer) {
                btn.classList.add('correct');
            }
        });

        const isCorrect = selectedAnswer === correctAnswer;
        if (isCorrect) {
            score++;
            button.classList.add('correct');
            const randomPhrase = positivePhrases[Math.floor(Math.random() * positivePhrases.length)];
            feedbackText.innerHTML = `âœ… Â¡Correcto! ${randomPhrase}`;
            feedbackText.style.color = 'var(--correct-color)';
        } else {
            button.classList.add('incorrect');
            const randomPhrase = encouragingPhrases[Math.floor(Math.random() * encouragingPhrases.length)];
            const lawLink = `<a href="https://www.google.com/search?q=${encodeURIComponent(currentQuizQuestions[currentQuestionIndex].ARTICULO)}" target="_blank">Consultar legislaciÃ³n</a>`;
            feedbackText.innerHTML = `ðŸ§  Incorrecto. ${randomPhrase} <br>La respuesta correcta es: <b>${correctAnswer}</b>. ${lawLink}`;
            feedbackText.style.color = 'var(--incorrect-color)';
            incorrectAnswers.push(currentQuizQuestions[currentQuestionIndex]);
        }
        
        updatePersistenceData(currentQuizQuestions[currentQuestionIndex].ID);
        nextQuestionBtn.classList.remove('hidden');
    }

    function showNextQuestion() {
        currentQuestionIndex++;
        displayQuestion();
    }
    
    function showResults() {
        quizScreen.style.display = 'none';
        resultsScreen.style.display = 'block';

        const percentage = currentQuizQuestions.length > 0 ? (score / currentQuizQuestions.length) * 100 : 0;
        scoreText.textContent = `Has acertado ${score} de ${currentQuizQuestions.length} preguntas (${percentage.toFixed(1)}%).`;
        motivationalClosing.textContent = closingPhrases[Math.floor(Math.random() * closingPhrases.length)];

        if (incorrectAnswers.length > 0) {
            reviewContainer.style.display = 'block';
            reviewList.innerHTML = '';
            incorrectAnswers.forEach(q => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <p class="review-question">${q.PREGUNTA}</p>
                    <p class="review-answer"><b>Respuesta correcta:</b> ${q.RESPUESTA} (${q.ARTICULO})</p>
                `;
                reviewList.appendChild(li);
            });
        } else {
            reviewContainer.style.display = 'none';
        }
        
        const usageCount = getFromStorage(storageKeys.usage);
        usageTableBody.innerHTML = '';
        const sortedUsage = Object.entries(usageCount).sort(([,a],[,b]) => b - a);

        sortedUsage.forEach(([id, count]) => {
            const question = flashcardsData.find(q => q.ID == id);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${id} (${question ? question.PREGUNTA.substring(0,40)+'...' : 'N/A'})</td>
                <td>${count}</td>
            `;
            usageTableBody.appendChild(tr);
        });
    }

    function updatePersistenceData(questionID) {
        const selectedTopic = topicSelect.value;
        let seenQuestions = getFromStorage(storageKeys.seen);
        if (!seenQuestions[selectedTopic]) {
            seenQuestions[selectedTopic] = [];
        }
        if (!seenQuestions[selectedTopic].includes(questionID)) {
            seenQuestions[selectedTopic].push(questionID);
        }
        saveToStorage(storageKeys.seen, seenQuestions);

        let usageCount = getFromStorage(storageKeys.usage);
        usageCount[questionID] = (usageCount[questionID] || 0) + 1;
        saveToStorage(storageKeys.usage, usageCount);
    }
    
    function generateIncorrectOptions(correctQuestion) {
        const { RESPUESTA, ARTICULO, BLOQUE } = correctQuestion;
        let distractors = new Set();
        const baseAnswer = `${RESPUESTA} (${ARTICULO})`;

        const numericMatches = baseAnswer.match(/\d+/g);
        if (numericMatches) {
            for (const numStr of numericMatches) {
                const num = parseInt(numStr);
                if (num > 2000) {
                    distractors.add(baseAnswer.replace(numStr, num - 1));
                    distractors.add(baseAnswer.replace(numStr, num + 1));
                } else if (num > 5) {
                    distractors.add(baseAnswer.replace(numStr, num + 1));
                    distractors.add(baseAnswer.replace(numStr, num - 2));
                } else {
                    distractors.add(baseAnswer.replace(numStr, num + 1));
                    if (num > 1) distractors.add(baseAnswer.replace(numStr, num - 1));
                }
                if (distractors.size >= 3) break;
            }
        }

        const keywordSwaps = {
            "meses": "semanas", "mes": "semana", "aÃ±os": "meses", "aÃ±o": "mes",
            "vendedor": "comprador", "comprador": "vendedor",
            "potestativo": "obligatorio", "objetiva": "subjetiva",
            "alzada": "reposiciÃ³n", "reposiciÃ³n": "alzada"
        };
        for (const key in keywordSwaps) {
            if (baseAnswer.includes(key)) distractors.add(baseAnswer.replace(key, keywordSwaps[key]));
            if (distractors.size >= 3) break;
        }

        if (distractors.size < 3) {
            const otherQuestions = shuffleArray(flashcardsData.filter(q => q.BLOQUE === BLOQUE && q.ID !== correctQuestion.ID));
            for (const otherQ of otherQuestions) {
                distractors.add(`${otherQ.RESPUESTA} (${otherQ.ARTICULO})`);
                if (distractors.size >= 3) break;
            }
        }
        
        if (distractors.size < 3) {
            distractors.add("Todas las anteriores son correctas.");
            distractors.add("Ninguna de las anteriores es correcta.");
        }

        distractors.delete(baseAnswer);
        return Array.from(distractors).slice(0, 3);
    }
    
    function shuffleArray(array) {
        const newArray = [...array];
        for (let i = newArray.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
    }

    /**
     * Genera y descarga un informe CSV con el recuento de uso de cada pregunta.
     * Esta funciÃ³n cumple con el requisito de generar un "fichero .csv" de manera
     * compatible con un navegador web.
     */
    function downloadUsageReport() {
        const usageCount = getFromStorage(storageKeys.usage);
        if (Object.keys(usageCount).length === 0) {
            alert("AÃºn no hay datos de uso para descargar.");
            return;
        }

        // Usar punto y coma como separador para mejor compatibilidad con Excel en configuraciones regionales espaÃ±olas
        let csvContent = "ID;Pregunta;Veces Formulada\r\n"; 

        const sortedUsage = Object.entries(usageCount).sort((a,b) => parseInt(a[0]) - parseInt(b[0]));

        for (const [id, count] of sortedUsage) {
            const questionData = flashcardsData.find(q => q.ID == id);
            if (questionData) {
                // Para evitar problemas con comas o puntos y comas en la pregunta, la encerramos entre comillas
                const questionText = `"${questionData.PREGUNTA.replace(/"/g, '""')}"`;
                csvContent += `${id};${questionText};${count}\r\n`;
            }
        }

        // Crear un objeto Blob para el contenido CSV
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        
        // Crear un enlace temporal para iniciar la descarga
        const link = document.createElement("a");
        if (link.download !== undefined) { // Feature detection
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "informe_uso_flashcards.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }

    </script>
</body>
</html>
